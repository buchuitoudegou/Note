# https

## SSL握手
1. 交换协议版本号
2. 选择一个两端都了解的密码
3. 对两端的身份认证
4. 产生临时的会话密钥

## 步骤
### 1. 客户端发起一个SSL/TLS连接
向服务端发送以下内容：
1. 支持的协议版本
2. 客户端生成的随机数n1
3. 加密方法，如RSA公钥加密
4. 支持的压缩方法

### 2. 服务端回应
1. 确认协议（版本不对，停止加密通信）
2. 生成服务端随机数n2
3. 确认加密方法
4. 服务器证书

### 3. 客户端回应
1. 客户端生成随机数n3（pre-master-key），并用证书里的公钥对其加密，并返回
2. 编码改变信息，表示随后的信息都将用双方商定的加密方法和密钥发送。
3. 客户端握手结束通知，表示客户端的握手阶段已经结束。这一项同时也是前面发送的所有内容的hash值，用来供服务器校验。

### 4. 服务端最后回应
1. 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。
2. 服务器握手结束通知，表示服务器的握手阶段已经结束。这一项同时也是前面发送的所有内容的hash值，用来供客户端校验。

完成握手后，客户端和服务端都用获取到的n1、n2、n3来生成一个对话密钥，用这个对话密钥进行对称加密通信信息。

## https的通信
在http和tcp之间多了SSL层，它会将HTTP报文加密，再交给tcp。同理，服务端在SSL层解密，再交给http层。

## 通过代理的https流量
如果遇到只能转发http流量的代理时，它无法为你转发https流量。这时候，我们就要用到HTTPS SSL隧道协议。

客户端首先告诉代理，它想要连接的安全主机和端口，利用http的CONNECT方法来发送明文形式的端点信息，CONNECT方法会告诉代理打开一条到所期望主机和端口号的连接。这项工作完成之后，直接在客户端和服务端之间以隧道的形式传输数据。