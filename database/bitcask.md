# bitcask

bitcask是一种基于日志存储的算法。一直向一个文件中写入"set"或者"rm"信息，当文件变得足够大的时候写入一个新文件。

在每个日志文件中，它每一行都包含：

Crc(校验码)、tstamp（时间戳）、ksz（key的大小）、value_sz（值的大小）、key、value

## 数据读取

为了读取的足够高效，在加载系统的时候，会在内存中存储一个索引哈希表，它记录了所有的key，以及这些key对应的位置信息，包括：文件id、value_sz、在文件中的位置（offset）、tstamp（时间戳）。

当我们get一个key时，会现在这个哈希表中找到对应的value的位置，再进行读取。

## 数据删除

每次删除一个值的时候，就像上文提到的那样，会在日志文件中加入一条删除日志，并不会把原来的信息覆盖或删除，同时更新内存中的索引哈希表，更新key在文件中的位置或删除这个key。同理，更改key的值也是如此。

## 数据清理

这样的算法会产生大量的冗余数据，为了清理这些数据，系统会定期做compact的操作。即，扫描所有旧的文件，移除掉过期的记录，并将还有效的记录写入新的文件。

### 过期记录

1. 如果这条记录中的key，和哈希表中的key的位置记录不符，认为这是过期的key记录
2. 如果是一条rm记录，可以直接认为是过期的

在合并这些日志之后，系统会生成一个hint文件，这会方便下次重启系统时不需要读取所有的日志